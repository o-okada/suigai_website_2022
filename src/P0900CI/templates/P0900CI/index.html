{% load django_bootstrap5 %}
{% load static %}
<!DOCTYPE html>
<html lang="ja">
<!-- P0900CI/templates/P0900CI/index.html -->
<!-- BEGIN Head -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="">
    <meta name="description" content="">
    <title>データ一貫性、整合性の自動検証画面 | 水害統計オンラインサイト</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.min.css' %}">
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
    .btn-fail    {background: #F44B25; color: #FFFFFF;}
    .btn-running {background: #258AC4; color: #FFFFFF;}
    .btn-cancel  {background: #6C757D; color: #FFFFFF;}
    .btn-success {background: #54AB51; color: #FFFFFF;}
    </style>
</head>
<!-- END Head -->

<!-- BEGIN Body -->
<body>
    {% bootstrap_messages %}
    {% block content %}

    <!-- BEGIN トップパネル -->
    <div class="container-fluid mb-3">
        <div class="row">
            <div class="col d-flex justify-content-start align-items-start">
                <a href="{% url 'P0000Dummy:index_view' %}">ダミーメニュー画面に戻る</a><br>
            </div>
            <div class="col d-flex justify-content-center align-items-center">
            </div>
            <div class="col d-flex justify-content-end align-items-end">
                <a href="{% url 'P0100Login:index_view' %}">ログアウト</a><br>
            </div>
        </div>
    </div>
    <!-- END トップパネル -->

    <!-- BEGIN 画面名 -->
    <div class="container text-center mb-3">
        <h3>データ一貫性、整合性の自動検証画面</h3>
    </div>
    <!-- END 画面名 -->
    
    <!-- BEGIN 検索とフィルタ -->
    <div class="row mb-3">
        <div class="col-12 col-xl-4">
            <div class="input-group">
                <select class="form-select" id="form_select_ken" name="form_select_ken">
                    <option value="0">都道府県の絞り込み条件を選択してください。</option>
                    {% for ken in ken_list %}
                    {% if ken.ken_code == ken_code %}
                    <option value="{{ ken.ken_code }}" selected>{{ ken.ken_name }}: {{ ken.ken_code }}</option>
                    {% else %}
                    <option value="{{ ken.ken_code }}">{{ ken.ken_name }}: {{ ken.ken_code }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
                <button class="btn btn-secondary btn-sm" type="button" id="button_ken" name="button_ken">都道府県選択</button>
            </div>
        </div>
        <div class="col-12 col-xl-4">
            <div class="input-group">
                <select class="form-select" id="form_select_city" name="form_select_city">
                    <option value="0">市区町村の絞り込み条件を選択してください。</option>
                    {% for city in city_list %}
                    {% if city.city_code == city_code %}
                    <option value="{{ city.city_code }}" selected>{{ city.city_name }}: {{ city.city_code }}</option>
                    {% else %}
                    <option value="{{ city.city_code }}">{{ city.city_name }}: {{ city.city_code }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
                <button class="btn btn-secondary btn-sm" type="button" id="button_city" name="button_city">市区町村選択</button>
            </div>
        </div>
        <div class="col-12 col-xl-4">
            <div class="input-group">
                <select class="form-select" id="form_select_status" name="form_select_status">
                    <option value="0">状態の絞り込み条件を選択してください。</option>
                    {% if status_code == '1' %}
                    <option value="1" selected>実行中</option>
                    <option value="2">キャンセル</option>
                    <option value="3">成功</option>
                    <option value="4">失敗</option>
                    {% elif status_code == '2' %}
                    <option value="1">実行中</option>
                    <option value="2" selected>キャンセル</option>
                    <option value="3">成功</option>
                    <option value="4">失敗</option>
                    {% elif status_code == '3' %}
                    <option value="1">実行中</option>
                    <option value="2">キャンセル</option>
                    <option value="3" selected>成功</option>
                    <option value="4">失敗</option>
                    {% elif status_code == '4' %}
                    <option value="1">実行中</option>
                    <option value="2">キャンセル</option>
                    <option value="3">成功</option>
                    <option value="4" selected>失敗</option>
                    {% else %}
                    <option value="1">実行中</option>
                    <option value="2">キャンセル</option>
                    <option value="3">成功</option>
                    <option value="4">失敗</option>
                    {% endif %}
                </select>
                <button class="btn btn-secondary btn-sm" type="button" id="button_status" name="button_status">状態選択</button>
            </div>
        </div>
    </div>
    <!-- END 検索とフィルタ -->

    <!-- BEGIN データ一貫性と整合性検証結果の時系列グラフ -->
    <div class="row mb-3">
        <div class="col-12 col-xl-12">
            <div id="columnchart"></div>
        </div>
    </div>
    <!-- END データ一貫性と整合性検証結果の時系列グラフ -->

    <!-- BEGIN データ一貫性と整合性検証結果の一覧表示 -->
    <div class="row mb-3">
        <div class="col-12 col-xl-12">
            <div class="table-responsive overflow-auto" style="">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="text-center">トリガー</th>
                            <th class="text-center">水害</th>
                            <th class="text-center">アクション</th>
                            <th class="text-center">状態</th>
                            <th class="text-center">発行日時</th>
                            <th class="text-center">消費日時</th>
                            <th class="text-center">成功数</th>
                            <th class="text-center">失敗数</th>
                            <th class="text-center">詳細</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trigger in trigger_list %}
                        <tr>
                            <td>{{ trigger.trigger_id }}</td>
                            <td>{{ trigger.suigai_id }}</td>
                            <td>{{ trigger.action_name }}:{{ trigger.action_code }}</td>
                            {% if trigger.status_code == '1' %}
                            <td><button class="btn btn-running btn-sm col-6" type="button">{{ trigger.status_name }}</button></td>
                            {% elif trigger.status_code == '2' %}
                            <td><button class="btn btn-cancel btn-sm col-6" type="button">{{ trigger.status_name }}</button></td>
                            {% elif trigger.status_code == '3' %}
                            <td><button class="btn btn-success btn-sm col-6" type="button">{{ trigger.status_name }}</button></td>
                            {% elif trigger.status_code == '4' %}
                            <td><button class="btn btn-fail btn-sm col-6" type="button">{{ trigger.status_name }}</button></td>
                            {% else %}
                            <td></td>
                            {% endif %}
                            <td>{{ trigger.published_at }}</td>
                            <td>{{ trigger.consumed_at }}</td>
                            <td>{{ trigger.success_count }}</td>
                            <td>{{ trigger.failure_count }}</td>
                            <td><a href="/P0900CI/repository/{{ trigger.repository_id }}">詳細</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- END データ一貫性と整合性検証結果の一覧表示 -->

    <script type="text/javascript">
    var button_ken = document.getElementById("button_ken"); // 都道府県選択ボタン
    var button_city = document.getElementById("button_city"); // 市区町村選択ボタン
    var button_status = document.getElementById("button_status"); // 状態選択ボタン
    
    // 都道府県選択ボタンクリック時のイベントハンドラを設定する。
    button_ken.addEventListener("click", function(event) {
        window.location.href = "/P0900CI/" + "ken/" + form_select_ken.value + "/city/0" + "/status/" + form_select_status.value + "/"
    });

    // 市区町村選択ボタンクリック時のイベントハンドラを設定する。
    button_city.addEventListener("click", function(event) {
        window.location.href = "/P0900CI/" + "ken/" + form_select_ken.value + "/city/" + form_select_city.value + "/status/" + form_select_status.value + "/"
    });
    
    // 状態選択ボタンクリック時のイベントハンドラを設定する。
    button_status.addEventListener("click", function(event) {
        window.location.href = "/P0900CI/" + "ken/" + form_select_ken.value + "/city/" + form_select_city.value + "/status/" + form_select_status.value + "/"
    });
    
    google.charts.load("current", {packages:['corechart']});
    google.charts.setOnLoadCallback(drawChart);
    function drawChart() {
        var data = google.visualization.arrayToDataTable([
            ['', '成功', '失敗', {role: 'style'}],
            {% for trigger in trigger_list %}
            {% if trigger.success_count != None %}
            ['{{ trigger.published_at }}', {{ trigger.success_count }}, {{ trigger.failure_count }}, ''], 
            {% endif %}
            {% endfor %}
        ]);
        var view = new google.visualization.DataView(data);
        var options = {
            legend: 'none', 
            bar: {groupWidth: '75%'}, 
            isStacked: true, 
            colors: ['#54AB51', '#F44B25'], 
            backgroundColor: '#f7f7f7' 
        };
        var chart = new google.visualization.ColumnChart(document.getElementById("columnchart"));
        chart.draw(view, options); 
    }
    </script>
    {% endblock %}
</body>
<!-- END Body -->
</html>
